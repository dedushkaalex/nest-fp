# Концепция Ротации Refresh-токенов

Ротация refresh-токенов — это продвинутая техника безопасности, которая значительно повышает защиту от кражи токенов. Она обнаруживает и блокирует попытки злоумышленников использовать украденный refresh-токен.

## 1. Классическая схема (без ротации)

В стандартной схеме refresh-токен является долгоживущим и многоразовым.

1.  **Вход**: Пользователь логинится и получает пару токенов:
    *   `Access Token` (короткоживущий, например, 15 минут).
    *   `Refresh Token` (долгоживущий, например, 30 дней).
2.  **Использование**: `Access Token` используется для доступа к защищенным ресурсам.
3.  **Обновление**: Когда `Access Token` истекает, пользователь отправляет `Refresh Token` на специальный эндпоинт (`/refresh`). Сервер проверяет `Refresh Token` и выдает **новый** `Access Token`. Старый `Refresh Token` при этом остается действительным и используется для последующих обновлений.

**Уязвимость**: Если `Refresh Token` будет украден, злоумышленник сможет в течение всего срока его жизни (30 дней) беспрепятственно получать новые `Access Token` и действовать от имени пользователя.

## 2. Схема с ротацией (Рекомендуемый подход)

В этой схеме `Refresh Token` становится **одноразовым**.

1.  **Вход**: Пользователь логинится и получает `Access Token_1` и `Refresh Token_1`.
2.  **Обновление**: Когда `Access Token_1` истекает, пользователь отправляет `Refresh Token_1` на эндпоинт `/refresh`.
3.  **Ротация**: Сервер проверяет `Refresh Token_1` и, если он валиден и не был использован ранее, выполняет следующие действия:
    *   Выдает **новый** `Access Token_2`.
    *   Выдает **НОВЫЙ** `Refresh Token_2`.
    *   Немедленно **инвалидирует** старый `Refresh Token_1`, помечая его как "использованный".

## Преимущества в безопасности: Обнаружение атаки

Магия этой схемы заключается в механизме обнаружения кражи.

1.  **Сценарий кражи**: Злоумышленник крадет `Refresh Token_1`.
2.  **Первое использование**: Неважно, кто первым использует `Refresh Token_1` — злоумышленник или легитимный пользователь. Допустим, первым был пользователь. Он успешно обновит сессию и получит `Access Token_2` и `Refresh Token_2`. `Refresh Token_1` будет помечен как использованный.
3.  **Попытка атаки**: Теперь злоумышленник пытается использовать украденный `Refresh Token_1`.
4.  **Обнаружение**: Сервер получает `Refresh Token_1`, проверяет его в своей базе данных (например, в Redis) и видит, что он **уже был использован**. Это однозначный признак **атаки повторного использования (replay attack)**.
5.  **Реакция на угрозу**: Сервер немедленно предпринимает защитные меры:
    *   Полностью аннулирует всю "семью" токенов, связанных с этой сессией (включая `Refresh Token_2`, который получил пользователь).
    *   Принудительно разлогинивает пользователя на всех устройствах.

Таким образом, при первой же попытке злоумышленника воспользоваться украденным токеном атака немедленно обнаруживается и блокируется, а скомпрометированная сессия — уничтожается.
